# 術語定義與設計原則

## 核心術語定義

### 基本概念

* **Device（設備）**: 連接 MQTT Broker 的設備，包含 IoT 裝置、伺服器、網路設備等。每個設備都有唯一的識別符並能夠發送診斷訊息和接收控制命令。

* **Controller（控制器）**: 發送命令並收集設備診斷資料的雲端或本地服務。控制器負責協調多個設備、分析診斷資料，並提供統一的管理介面。

* **Broker**: MQTT 訊息代理伺服器，負責接收、路由和分發所有 MQTT 訊息。作為設備與控制器間的通信中介。

* **Tenant/Site（租戶/場域）**: 用於資料隔離與路由的層級概念。租戶代表組織或用戶群組，場域代表特定的物理或邏輯位置。

* **Topic（主題）**: MQTT 主題路徑，定義訊息的分類和路由規則。RTK MQTT 使用結構化的主題命名規範。

### 進階概念

* **LWT (Last Will and Testament)**: 遺囑訊息，MQTT 的內建機制。當設備意外斷線時（如網路故障、設備當機），MQTT Broker 會自動發布事先設定的「遺囑訊息」通知其他訂閱者，實現即時的離線檢測。這是確保 IoT 系統可靠性的關鍵機制。

* **Diagnosis（診斷）**: 設備健康狀態、效能指標、錯誤資訊等診斷資料的統稱。包括但不限於系統狀態、網路連線品質、硬體資源使用情況等。

* **Session（會話）**: LLM 診斷系統中的對話會話，用於追蹤多輪診斷交互。每個會話有唯一的 `session_id`。

* **Trace（追蹤）**: 單一診斷操作的完整追蹤記錄，包含相關的命令執行和資料收集過程。每個追蹤有唯一的 `trace_id`。

### 訊息類型術語

* **State（狀態）**: 設備的基本健康狀態和重要資訊的快照，通常為 retained 訊息。

* **Telemetry（遙測）**: 設備定期發送的監控數據，如效能指標、感測器讀數等。

* **Event（事件）**: 設備發生的重要事件通知，如連線變化、錯誤發生等。

* **Attribute（屬性）**: 設備的靜態或半靜態資訊，如硬體規格、韌體版本等。

* **Command（命令）**: 控制器向設備發送的操作指令，包括請求(req)、確認(ack)、回應(res)。

* **Topology（拓撲）**: 網路拓撲相關的訊息，用於描述設備間的連線關係。

### LLM 相關術語

* **Capability（能力）**: 設備支援的功能和診斷能力清單，用於 LLM 系統的動態發現。

* **Tool（工具）**: LLM 診斷系統中的功能模組，分為 Read（讀取）、Test（測試）、Act（執行）三類。

* **Changeset（變更集）**: 一組相關的配置變更操作，支援原子操作和回滾機制。

## 設計原則

### 1. 統一主題結構
**原則**: 以設備為中心的上下行訊息路徑設計

**說明**: 所有訊息都圍繞設備進行組織，採用層級化的主題結構，確保訊息路由的清晰性和一致性。每個設備的所有訊息類型都在其專屬的主題空間下統一管理。

**實踐**:
- 使用統一的主題格式：`rtk/v1/{tenant}/{site}/{device_id}/{message_type}`
- 設備相關的所有訊息類型都在同一主題樹下
- 支援萬用字元訂閱以便於監控和除錯

### 2. 可擴充性
**原則**: 命令與 Schema 獨立演進，使用語義化版本控制

**說明**: 協議設計支援向後相容的演進，新功能的加入不會影響現有系統的運作。通過版本控制和可選欄位機制，確保新舊系統能夠共存。

**實踐**:
- 使用語義化版本號（Semantic Versioning）
- 新欄位設計為可選項，提供預設值
- Schema 獨立版本控制，支援混合版本環境
- 協議層面的向下相容性保證

### 3. 可觀測性  
**原則**: 支援全域與範圍訂閱模式，便於監控與除錯

**說明**: 系統設計充分考慮運維需求，提供多層次的監控和觀測能力。支援從全域到特定設備的彈性訂閱模式。

**實踐**:
- 支援萬用字元訂閱模式（`+` 和 `#`）
- 提供分層的監控範圍（全域/租戶/場域/設備）
- 內建診斷和除錯資訊
- 支援訊息追蹤和審計

### 4. 診斷導向
**原則**: 專注於設備健康狀態、效能指標與故障診斷資訊的結構化傳輸

**說明**: 協議專門針對診斷和監控場景進行最佳化，特別支援網路診斷、設備健康監控和故障排除。

**實踐**:
- 結構化的診斷資料格式
- 支援 WiFi 連線品質、漫遊事件、掃描結果等無線網路診斷
- 內建網路拓撲發現和追蹤
- 整合 LLM 技術提供智慧診斷能力

### 5. 安全性和隔離
**原則**: 多租戶資料隔離，權限分級管理

**說明**: 通過租戶和場域的層級設計，確保不同用戶和環境的資料隔離。對於敏感操作提供權限控制機制。

**實踐**:
- 基於主題的天然資料隔離
- 支援 MQTT 認證和授權機制
- 敏感命令的權限分級（如 Act 工具需要特殊權限）
- 操作審計和追蹤記錄

### 6. 即時性和可靠性
**原則**: 平衡即時性需求與系統可靠性

**說明**: 針對不同類型的訊息採用適當的 QoS 等級和傳輸策略，確保重要訊息的可靠傳輸，同時避免系統過載。

**實踐**:
- 基於訊息重要性的 QoS 等級選擇
- 使用 LWT 機制確保設備離線檢測
- 支援訊息去重和冪等性設計
- 適當的訊息頻率控制

## 架構概念

### 層級結構
```
組織層級: Tenant (租戶)
  ↓
地理層級: Site (場域)
  ↓  
設備層級: Device (設備)
  ↓
功能層級: Message Type (訊息類型)
```

### 通信模式

**上行通信** (Device → Controller):
- 狀態報告：設備主動報告健康狀態
- 遙測數據：定期傳送監控資料  
- 事件通知：重要事件的即時通知
- 拓撲資訊：網路連接關係資料

**下行通信** (Controller → Device):
- 命令執行：遠端控制和配置變更
- 診斷請求：主動診斷和資料收集
- 配置推送：系統配置和參數更新

### 資料流向

```
設備感測 → 資料收集 → 訊息封裝 → MQTT 發布 → 控制器接收 → 資料分析 → 決策制定 → 命令下發 → 設備執行
```

## 下一步

了解了基本術語和設計原則後，請繼續閱讀 [Topic 結構](04-topic-structure.md) 了解詳細的主題命名規範。

---

**注意**: 本文檔中的術語定義在整個 RTK MQTT 協議規格中保持一致，建議在實作前充分理解這些概念。