# RTK MQTT 協議概述

## 協議簡介

RTK MQTT 診斷通訊協定 (rtkMQTT) v1.0 是一個專為 IoT 設備診斷和網路管理設計的通信協議，基於 MQTT 3.1.1 標準構建。本協議定義了設備與控制器間的標準化通訊格式，支援狀態回報、遙測數據、事件通知與命令執行等核心功能。

### 主要特色

- **標準化通信**: 基於成熟的 MQTT 3.1.1 協議，確保互操作性
- **結構化數據**: 採用 JSON 格式訊息，支援 Schema 驗證
- **設備管理**: 自動設備發現與生命週期管理
- **網路診斷**: 內建網路診斷與分析功能
- **LLM 整合**: 支援 AI 驅動的自動化診斷系統
- **多租戶支援**: 支援企業級多租戶、多站點部署
- **可靠性保證**: LWT (Last Will Testament) 機制確保設備狀態追蹤

### 適用範圍

本協議適用於各類 IoT 設備的診斷狀態回報，包括但不限於：

- **網路設備**: 路由器、交換機、無線存取點
- **終端設備**: 網路介面卡、感測器、智慧設備
- **伺服器設備**: 主機、虛擬機、容器
- **診斷工具**: 網路分析器、測試設備
- **管理系統**: 控制器、監控平台

### 協議架構

```
┌─────────────────┐    MQTT Topics    ┌─────────────────┐
│   IoT Devices   │ ←──────────────→ │   Controller    │
│                 │                   │                 │
│ • 路由器/AP     │    上行訊息        │ • 拓撲管理      │
│ • 交換機        │    - state        │ • 診斷分析      │
│ • NIC/感測器    │    - telemetry    │ • 命令控制      │
│ • 智慧設備      │    - evt          │ • LLM 整合      │
│                 │    - attr         │                 │
│                 │    - topology     │                 │
│                 │                   │                 │
│                 │    下行命令        │                 │
│                 │    - cmd/req      │                 │
│                 │    - cmd/ack      │                 │
│                 │    - cmd/res      │                 │
└─────────────────┘                   └─────────────────┘
```

## 變更歷史

### v1.0 (2024-08-20) - LLM 自動化診斷擴展

#### 新增功能
- **LLM 診斷系統整合支援**: 完整的 AI 診斷工具整合框架
- **會話管理和追蹤系統**: 新增 `session_id` 和 `trace_id` 欄位支援多輪對話
- **設備能力發現機制**: 新增 `capabilities` 欄位，支援動態能力發現
- **變更集管理和回滾功能**: 支援配置變更的原子操作和回滾
- **Read/Test/Act 工具分類系統**: 三層工具分類，支援不同權限等級

#### 擴展錯誤碼
- 新增 22 個 LLM 診斷專用錯誤碼 (從 E_LLM_CONTEXT_INIT_FAILED 開始)
- 涵蓋會話管理、工具執行、權限控制等各個面向

#### 增強安全性
- **Act 工具權限管理**: 對執行類工具進行嚴格權限控制
- **會話隔離**: 不同診斷會話間的數據隔離機制
- **操作審計**: 完整的操作日誌和追蹤記錄

#### 向下相容性
- 所有新功能都為選用欄位，不影響現有 v1.0 設備的正常運行
- 保持與舊版本設備的完全互操作性
- 支援混合環境部署和漸進式升級

## 協議版本資訊

- **協議版本**: v1.0
- **MQTT 版本**: 3.1.1
- **訊息格式**: JSON
- **字符編碼**: UTF-8
- **發布日期**: 2024-08-20
- **協議狀態**: 穩定版本

## 設計目標

### 1. 互操作性
確保不同廠商、不同平台的設備能夠無縫整合，支援標準化的通訊介面。

### 2. 可擴展性
支援大規模部署，從單一設備到數萬設備的企業級網路管理。

### 3. 即時性
提供即時的設備狀態監控、事件通知和命令回應機制。

### 4. 可靠性
通過 QoS 保證、重試機制和 LWT 確保訊息的可靠傳輸。

### 5. 智能化
整合 LLM 技術，提供 AI 驅動的自動化診斷和問題解決能力。

## 相關文檔

- **詳細規格**: 請參考本目錄下的其他規格文件
- **實作範例**: [../developers/](../developers/) - 開發者整合指南
- **測試工具**: [../../test/](../../test/) - 測試框架和範例
- **配置範例**: [../../configs/](../../configs/) - 參考配置文件

---

**下一步**: 查看 [前置要求](02-prerequisites.md) 了解必要的依賴程式庫