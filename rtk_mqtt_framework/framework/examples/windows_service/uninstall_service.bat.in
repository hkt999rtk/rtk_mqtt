@echo off
REM === RTK MQTT Collector Service Uninstallation Script ===
REM 
REM This script removes the RTK MQTT Collector Windows Service
REM Requires Administrator privileges to run
REM

echo RTK MQTT Collector Service Uninstallation
echo ==========================================

REM Check for administrator privileges
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo ERROR: This script requires Administrator privileges.
    echo Please run as Administrator.
    pause
    exit /b 1
)

set SERVICE_NAME=RTKMqttCollector

echo Service Name: %SERVICE_NAME%
echo.

REM Check if service exists
sc query %SERVICE_NAME% >nul 2>&1
if %errorlevel% neq 0 (
    echo Service %SERVICE_NAME% does not exist or is not installed.
    echo Nothing to uninstall.
    pause
    exit /b 0
)

REM Show current service status
echo Current service status:
sc query %SERVICE_NAME%
echo.

REM Stop the service if it's running
echo Stopping service...
net stop %SERVICE_NAME%

REM Wait a moment for the service to stop completely
timeout /t 3 /nobreak >nul

REM Check if service is still running
sc query %SERVICE_NAME% | find "STOPPED" >nul 2>&1
if %errorlevel% neq 0 (
    echo WARNING: Service may still be running or stopping.
    echo Waiting for service to stop completely...
    timeout /t 5 /nobreak >nul
    
    REM Force stop if necessary (be careful with this)
    sc query %SERVICE_NAME% | find "RUNNING" >nul 2>&1
    if %errorlevel% == 0 (
        echo WARNING: Service is still running. Attempting to force stop...
        taskkill /F /IM RTKMqttCollector.exe >nul 2>&1
        timeout /t 2 /nobreak >nul
    )
)

REM Delete the service
echo Deleting service...
sc delete %SERVICE_NAME%

if %errorlevel% == 0 (
    echo Service deleted successfully!
    echo.
    echo The service has been removed from the system.
    echo You may need to restart the computer for all changes to take effect.
) else (
    echo ERROR: Failed to delete service.
    echo The service may still be in use or have dependencies.
    echo.
    echo Try the following:
    echo 1. Make sure the service is completely stopped
    echo 2. Close any applications that might be using the service
    echo 3. Restart the computer and try again
    echo 4. Use Services.msc to manually stop and delete the service
)

echo.
echo Cleanup completed.

REM Ask if user wants to delete log files (optional)
set /p DELETE_LOGS=Delete application logs from Event Viewer? (Y/N): 
if /i "%DELETE_LOGS%" == "Y" (
    echo Clearing event logs...
    REM Note: This clears the entire Application log, not just our service logs
    REM In production, you might want to use a more selective approach
    wevtutil cl Application 2>nul
    if %errorlevel% == 0 (
        echo Application event log cleared.
    ) else (
        echo Could not clear event logs. You can manually clear them in Event Viewer.
    )
) else (
    echo Event logs preserved.
    echo You can view service logs in Event Viewer under Windows Logs ^> Application
    echo Filter by Source: %SERVICE_NAME%
)

echo.
echo Uninstallation completed.
pause